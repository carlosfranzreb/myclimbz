{# Macro to display a card with a header and facts of a route, opinion, etc. #}
{% macro card(data) %}
<div class="card mb-3">
    <div class="card-header">
        <div class="row">
            <div class="col-sm">
                <h5 class="card-title" style="display: inline-block">{{ data['header']['title'] }}</h5>
                {% if data['header']['title_actions'] %}
                {% for action in data['header']['title_actions'] %}
                {% if action['icon'] == 'delete' %}
                <a href="{{ action['url'] }}"  onclick="return confirm('Are you sure you want to delete this?');">
                {% else %}
                <a href="{{ action['url'] }}">
                {% endif %}
                    {% include 'icons/' ~ action['icon'] ~ '.html' %}
                </a>
                {% endfor %}
                {% endif %}
            </div>
            {% if data['header']['subtitle'] %}
                <span>{{ data['header']['subtitle'] }}</span>
            {% endif %}
        </div>
    </div>
    {% if data['body']['facts'] %}
    <div class="card-body">
        <div class="row">
            {% for fact in data['body']['facts'] %}
            <div class="col text-center" style="padding: 0">
                <span style="vertical-align: middle; display: inline-block;">
                    {% include 'icons/' ~ fact['icon'] ~ '.html' %}
                </span>
                <span style="vertical-align: middle; display: inline-block;">
                    {% if fact['value'] is none %}
                        N/A
                    {% elif fact['value'] is float and fact['value'] % 1 == 0 %}
                        {{ fact['value']|int }}{{ fact['unit'] }}
                    {% else %}
                        {{ (fact['value']) }}{{ fact['unit'] }}
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% if data['body']['list'] %}
    <ul class="list-group list-group-flush">
        {% for item in data['body']['list'] %}
            {% if 'prefix' in item or item['value']|length > 0 %}
                <li class="list-group-item">

                    {% if item['prefix'] %}
                        <b>{{ item['prefix'] }}:</b>
                    {% endif %}

                    {% if item['value'] %}
                        {% if item['value'] != "N/A" and (item['prefix'] == "Link" or item['prefix'] == "Media") %}
                            <a href="{{ item['value'] }}" target="_blank">{{ item['value'] }}</a>
                        {% else %}
                            {{ item['value'] }}
                        {% endif %}
                    {% endif %}

                </li>
            {% endif %}
        {% endfor %}
    </ul>
    {% endif %}
</div>
{% endmacro %}


{# Macro to display the three forms (route, climb and opinion) #}
{% macro three_forms(forms) %}

{% for form in forms %}
    <div class="mb-4">
        {{ form.hidden_tag() }}

        <!-- Form titles are used for multi-forms -->
        {% if form.title %}
            <h4>{{ form.title }}</h4>
        {% endif %}

        {% for field in form %}
            {% if field.name != 'csrf_token' and field.name != "submit" and field != form.existing_route %}
                <div class="form-group">

                    <!-- Add the field label -->
                    {{ field.label(id=field.id + "-label") }}
                    
                    <!-- Add a range input if the field has a type of IntegerRangeField or DecimalRangeField -->
                    {% if field.type == 'IntegerRangeField' or field.type == 'DecimalRangeField' %}
                        <span>= </span>
                        <output id="{{ field.id }}-output">{{ field.default }}</output>
                        <span>{{ field.unit }}</span>
                        {{ field(id=field.id, class='form-range',
                        oninput="this.previousElementSibling.previousElementSibling.value
                        = this.value") }}

                    <!-- Add a checkbox if the field has a type of BooleanField and place the label beside it -->
                    {% elif field.type == 'BooleanField' %}
                        {% if field.toggle_ids %}
                            {{ field(
                                id=field.id,
                                class='form-check',
                                onchange='checkboxToggle("' + field.id + '", "' + field.toggle_ids + '")'
                            ) }}
                        {% else %}
                            {{ field(id=field.id, class='form-check') }}
                        {% endif %}
                        <script>
                            document.getElementById("{{ field.id }}").parentElement.style.display = "flex";
                            document.getElementById("{{ field.id }}").parentElement.style.marginTop = "0.5em"
                            document.getElementById("{{ field.id }}").parentElement.style.marginBottom = "0.75em";
                            document.getElementById("{{ field.id }}").style.cursor = "pointer";
                            document.getElementById("{{ field.id }}-label").style.cursor = "pointer";
                            document.getElementById("{{ field.id }}-label").classList.add("label-checkbox");
                        </script>

                    <!-- Add a datalist if the field has a datalist attribute -->
                    {% elif field.datalist %}
                        {% set datalist_name = field.name + '-list' %}
                        {% set relation_field = field.relation_field if field.relation_field is defined else "" %}
                        {% set relation_data = field.relation_data | tojson if field.relation_data is defined else "" %}
                        <datalist id="{{ field.name }}-list">
                            {% for item in field.datalist %}
                            <option value="{{ item }}"></option>
                            {% endfor %}
                        </datalist>
                        {% if field.toggle_ids %}
                            {{ field(
                                id=field.id,
                                class='form-control',
                                list=datalist_name,
                                autocomplete='off',
                                onchange='datalistToggle("' + field.id + '", "' + field.toggle_ids + '", "' + relation_field + '", "' + relation_data + '")'
                            ) }}
                        {% else %}
                            {{ field(id=field.id, class='form-control', list=datalist_name, autocomplete='off') }}
                        {% endif %}

                    <!-- Otherwise, we assume the field is a text input -->
                    {% else %}
                        {{ field(id=field.id, class='form-control') }}
                    {% endif %}

                    <!-- Add error messages if there are any -->
                    {% if field.errors %}
                        <div class="invalid-feedback">
                            {% for error in field.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                        <script>
                            document.getElementById("{{ field.id }}").classList.add("is-invalid");
                            document.getElementById("{{ field.id }}-label").style.color = "red";
                        </script>
                    {% endif %}

                </div>
            {% endif %}
        {% endfor %}
    </div>
    <hr>
{% endfor %}

<script>

document.addEventListener("DOMContentLoaded", function() {

    // Exit if there is no route form
    let routeNameInput = document.getElementById("name");
    if (!routeNameInput)
        return;

    let existingRoutes = document.getElementById("name-list").options;
    let opinionFormExists = Array.from(document.getElementsByTagName("h4")).some(el => el.textContent.trim() === "Opinion");
    let climbFormExists = Array.from(document.getElementsByTagName("h4")).some(el => el.textContent.trim() === "Climb");

    function resetForm(formTitle) {
        // Find the H4 element with the matching title to get the form container
        let titleElement = Array.from(document.getElementsByTagName("h4")).find(function(el) {
            return el.textContent.trim() === formTitle;
        });
        let formContainer = titleElement.parentElement;

        // Remove the 'fetched from database' messages
        let fetchedMsg = titleElement.nextElementSibling;
        if (fetchedMsg && fetchedMsg.tagName === 'P' && fetchedMsg.classList.contains('text-muted') && fetchedMsg.textContent.includes("fetched from the database")) {
            fetchedMsg.remove();
        }
        let nAttemptsDbInfo = formContainer.querySelector("#n_attempts-db-info");
        if (nAttemptsDbInfo) {
            nAttemptsDbInfo.remove();
        }

        // Reset form fields
        let fields = formContainer.querySelectorAll('input[type=text], input[type=number], input[type=checkbox], input[type=range], select, textarea');
        fields.forEach(function(field) {
            switch (field.type) {

                // Reset range sliders to 3 and update their output
                case 'range':
                    field.value = '3';
                    let output = document.getElementById(field.id + "-output"); 
                    output.value = '3';
                    break;

                // Uncheck checkboxes
                case 'checkbox':
                    field.checked = false;
                    break;
                
                // Clear text-based inputs, textareas and number-based inputs
                case 'textarea':
                case 'text':
                case 'number':
                    field.value = '';
                    break;
                
                // Select first option of select field (should be an empty string)
                case 'select-one':
                    field.selectedIndex = 0;
                    break;

            }
        }); 
    }

    function fetchDataAndUpdateForm(url, func, formTitle)Â {
        fetch(url)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {

                if (!data || Object.keys(data).length === 0)
                    return resetForm(formTitle);
                else
                    return func(data);
            })
            .catch(function(error) {
                console.error("Error fetching data:", error);
            });
    }

    function updateOpinionForm(data) {

        // Add a paragraph below the title warning the user that this info was fetched from the DB
        let opinionTitleElement = Array.from(document.getElementsByTagName("h4")).find(function(el) {
            return el.textContent.trim() === "Opinion";
        });
        if (opinionTitleElement) {
            opinionTitleElement.insertAdjacentHTML("afterend", '<p class="text-muted">Existing opinion was fetched from the database.</p>');
        }

        // Update grade and comment; both could be null (TODO: comment QA)
        ["grade", "opinion_comment"].forEach(function(field) {
            if (data[field])
                document.getElementById(field).value = data[field];
        });

        // Update rating and landing slider values and their labels
        ["rating", "landing"].forEach(function(field) {
            document.getElementById(field).value = data[field];
            document.getElementById(field + "-output").value = data[field];
        });

        // Update cruxes
        var cruxesList = document.getElementById("cruxes");
        var checkboxes = cruxesList.querySelectorAll("input[type='checkbox']");
        checkboxes.forEach(function(checkbox) {
            var label = checkbox.nextElementSibling;
            var cruxName = label ? label.textContent.trim() : "";
            checkbox.checked = data.cruxes.includes(cruxName);
        });
    }

    function updateClimbForm(data) {
        
        // Add a paragraph below the title warning the user that this info was fetched from the DB
        let opinionTitleElement = Array.from(document.getElementsByTagName("h4")).find(function(el) {
            return el.textContent.trim() === "Climb";
        });
        if (opinionTitleElement) {
            opinionTitleElement.insertAdjacentHTML("afterend", '<p class="text-muted">Existing climb was fetched from the database.</p>');
        }

        // Update texts
        ["climb_comment", "climb_link"].forEach(function(field) {
            if (data[field])
                document.getElementById(field).value = data[field];
        });

        // Update the checkboxes for "sent" and "flashed"
        ["sent", "flashed"].forEach(function(field) {
            document.getElementById(field).checked = data[field];
        });

        // Update the number of attempts
        let nAttemptsField = document.getElementById("n_attempts");
        if (nAttemptsField) {
            let currentValue = parseInt(nAttemptsField.value, 10) || 0;
            let fetchedAttempts = parseInt(data.n_attempts, 10) || 0;
            nAttemptsField.value = currentValue + fetchedAttempts;
            let infoText = "No. of attempts in database: " + fetchedAttempts
            let dbInfoId = "n_attempts-db-info";
            let dbInfoParagraph = document.getElementById(dbInfoId);
            if (dbInfoParagraph) {
                dbInfoParagraph.textContent = infoText;
            } else {
                dbInfoParagraph = document.createElement("p");
                dbInfoParagraph.id = dbInfoId;
                dbInfoParagraph.className = "text-muted";
                dbInfoParagraph.textContent = infoText;
                nAttemptsField.parentElement.appendChild(dbInfoParagraph);
            }
        }
    }

    // Event listeners to update forms when route name is changed
    routeNameInput.addEventListener("change", function() {
        let routeName = this.value;
        let routeExists = Array.from(existingRoutes).some(option => option.value === routeName);
        if (!routeExists) {
            resetForm("Climb");
            resetForm("Opinion"); 
        }

        let routeNameEncoded = encodeURIComponent(routeName)
        if (opinionFormExists)
            fetchDataAndUpdateForm("/get_opinion_from_route_name/" + routeNameEncoded, updateOpinionForm, "Opinion");
        if (climbFormExists)
            fetchDataAndUpdateForm("/get_climb_from_route_name/" + routeNameEncoded, updateClimbForm, "Climb");
    });
});
</script>

{% endmacro %}