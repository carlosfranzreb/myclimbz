{% import "macros.html" as macros %}

{% extends "main.html" %}
{% block content %}

<div class="container px-2 px-md-5">
    <h2 class="mt-2">{{ title }}</h2>
    <p>Use keys A and D to navigate frames, or click on the left or right of the image.</p>

    <div class="text-center mb-3">
        <img 
            id="frame-image"
            src="{{ url_for('videos.serve_file', filetype='frames', filename=frames_fname_prefix + '0.jpg') }}"
            alt="Video Frame" style="max-width: 100%; height: auto; max-height: 60vh; border: 1px solid #ccc;"
            onmousedown="(function(evt){
                var key = evt.offsetX > evt.currentTarget.clientWidth / 2 ? 'd' : 'a';
                document.dispatchEvent(new KeyboardEvent('keydown', {key: key}));
                evt.currentTarget.dispatchInterval = setInterval(function(){
                    document.dispatchEvent(new KeyboardEvent('keydown', {key: key}));
                }, 100);
            })(event)"
            onmouseup="clearInterval(event.currentTarget.dispatchInterval);"
            onmouseleave="clearInterval(event.currentTarget.dispatchInterval);"
        >
        <div>
            Frame: <span id="current-frame-num">1</span> / <span id="total-frames">{{ n_frames }}</span>
        </div>
    </div>

    <div class="mb-3 text-center">
        <button type="button" id="mark-start-btn" class="btn btn-success me-2">Mark Start</button>
        <button type="button" id="mark-end-btn" class="btn btn-info">Mark End</button>
    </div>

    <form method="POST">
        {{ video_form.hidden_tag() }}

        <h4>Climbing Sections</h4>
        <div id="sections-container">
            {% for section_field in video_form.sections %}
            <div class="section-entry row align-items-center mb-2 border p-2 rounded" data-index="{{ loop.index0 }}">
                 <div class="col-md-5">
                    {{ section_field.start.label(class="form-label") }}
                    {{ section_field.start(class="form-control form-control-sm start-input") }}
                    {% if section_field.start.errors %}
                        <div class="invalid-feedback d-block"> {{ section_field.start.errors|join(', ') }}</div>
                    {% endif %}
                 </div>
                 <div class="col-md-5">
                    {{ section_field.end.label(class="form-label") }}
                    {{ section_field.end(class="form-control form-control-sm end-input") }}
                     {% if section_field.end.errors %}
                        <div class="invalid-feedback d-block"> {{ section_field.end.errors|join(', ') }}</div>
                    {% endif %}
                 </div>
                 {% if loop.index0 > 0 %}
                 <div class="col-md-2 text-end"></div>
                     <button type="button" class="btn btn-danger btn-sm remove-section-btn mt-2">Remove</button>
                 </div>
                 {% endif %}
                  {% if section_field.errors and 'start' not in section_field.errors and 'end' not in section_field.errors %} {# Catch form-level errors #}
                    <div class="col-12">
                        {% for error in section_field.errors.values()|sum(start=[]) %}
                         <div class="invalid-feedback d-block">{{error}}</div>
                        {% endfor %}
                    </div>
                  {% endif %}
            </div>
            {% endfor %}
        </div>

        <button type="button" id="add-section-btn" class="btn btn-secondary my-2">Add Section</button>

        <hr>
        {{ macros.three_forms(other_forms) }}

        <input type="submit" class="btn btn-primary" value="Submit">
        <a href="{{ url_for('home.cancel_form') }}" class="btn btn-danger ms-2">Cancel</a>

    </form>

    <div id="section-template" style="display: none;">
        <div class="section-entry row align-items-center mb-2 border p-2 rounded" data-index="__prefix__">
            <div class="col-md-5">
                <label class="form-label" for="sections-__prefix__-start">Start</label>
                <input class="form-control form-control-sm start-input" id="sections-__prefix__-start" name="sections-__prefix__-start" type="number" value="">
            </div>
            <div class="col-md-5">
                <label class="form-label" for="sections-__prefix__-end">End</label>
                <input class="form-control form-control-sm end-input" id="sections-__prefix__-end" name="sections-__prefix__-end" type="number" value="">
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-danger btn-sm remove-section-btn">Remove</button>
            </div>
        </div>
    </div>

</div>

<script src="{{url_for('static', filename='js/form_videos_annotation.js')}}"></script>


<style>
    /* Visual feedback for the active section */
    .section-entry:focus-within {
        background-color: var(--color-green-300);
    }
</style>

{% endblock content %}