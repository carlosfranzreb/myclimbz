{% extends "main.html" %}
{% block content %}

<div class="container px-0 px-lg-5">
    <div class="card mb-3">
        <div class="card-header">
            <div class="row">
                <div class="col-sm">
                    <h5 class="card-title" style="display: inline-block">{{ route.name }} {{ route.consensus_grade_str
                        }}</h5>
                    {% if route.created_by == user_id or user_role == 1 %}
                    <a href="{{ url_for('routes.edit_route', route_id=route.id) }}">
                        {% include 'icons/edit.html' %}
                    </a>
                    <a href="{{ url_for('routes.delete_route', route_id=route.id) }}">
                        {% include 'icons/delete.html' %}
                    </a>
                    {% endif %}
                </div>
                <div class="col-sm">
                    <span>{{ route.sector.name }}, {{route.sector.area.name }}</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/height.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;">{{
                        (route.height|string).rstrip('.0')
                        }} m</span>
                </div>
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/inclination.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;">{{ route.inclination }}Â°</span>
                </div>
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/rating.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;"> {{
                        (route.rating|string).rstrip('.0')
                        }}/5</span>
                </div>
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/landing.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;"> {{
                        (route.landing|string).rstrip('.0')
                        }}/5</span>
                </div>
            </div>
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
                <div class="row">
                    <div>
                        <b>Cruxes:</b> {{ route.cruxes|join(", ") }}
                    </div>
                    <div>
                        <b>Sends / tries:</b> {{ route.n_sends }} / {{ route.n_climbers }}
                    </div>

                    <div>
                        <b>Coordinates:</b>
                        {% if route.latitude and route.longitude %}
                        {{ route.latitude }}, {{ route.longitude }}
                        {% else %}
                        Not available
                        {% endif %}
                    </div>

                </div>
            </li>
            <li class="list-group-item"> {{ route.comment }}</li>
        </ul>
    </div>
</div>

<div class="container px-0 px-lg-5">
    <h3 class="mx-3">My sessions</h3>
    {% if route.climbs|selectattr("session.climber_id", "equalto", user_id)|list|length > 0 %}
    <table id="content_table" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Date</th>
                <th># Attempts</th>
                <th>Conditions</th>
                <th>Sent</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for climb in route.climbs if climb.session.climber_id == user_id %}

            {% set onclick = "window.location=\"" + url_for('sessions.page_session', session_id=climb.session.id) +
            "\""
            %}
            {% if climb.sent %}
            <tr class="table-success">
                {% else %}
            <tr>
                {% endif %}

                <td onclick={{ onclick }}>{{ climb.session.date }}</td>
                <td onclick={{ onclick }}>{{ climb.n_attempts }}</td>
                <td onclick={{ onclick }}>{{ climb.session.conditions }}</td>
                <td onclick={{ onclick }}>{{ climb.sent }}</td>
                <td>
                    <a href="{{ url_for('climbs.edit_climb', climb_id=climb.id) }}">
                        {% include 'icons/edit.html' %}
                    </a>
                    <a href="{{ url_for('climbs.delete_climb', climb_id=climb.id) }}">
                        {% include 'icons/delete.html' %}
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="col-xs-12">
        <p>No sessions yet</p>
        {% if route.is_project %}
        <a href="{{ url_for('climbers.add_project', route_id=route.id) }}" class="btn btn-success">Save as
            project</a>
        {% else %}
        <a href="{{ url_for('climbers.delete_project', route_id=route.id) }}" class="btn btn-danger">Remove from
            projects</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="container px-0 px-lg-5">
    {% if route.opinions|selectattr("climber_id", "equalto", user_id)|list|length > 0 %}
    {% for opinion in route.opinions if opinion.climber_id == user_id %}
    <h3 class="mx-3" style="display: inline-block">My opinion</h3>
    <a href="{{ url_for('opinions.edit_opinion', opinion_id=opinion.id) }}">
        {% include 'icons/edit.html' %}
    </a>
    <a href="{{ url_for('opinions.delete_opinion', opinion_id=opinion.id) }}">
        {% include 'icons/delete.html' %}
    </a>
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="card-title">{{ opinion.climber.name }}</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/grade.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;">{{ opinion.grade.user_grade
                        }}</span>
                </div>
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/rating.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;"> {{ opinion.rating }}/5</span>
                </div>
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/landing.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;"> {{ route.landing }}/5</span>
                </div>
            </div>
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item"><b>Cruxes:</b> {{ opinion.cruxes|map(attribute="name")|join(", ") }}</li>
            <li class="list-group-item">{{ opinion.comment }}</li>
        </ul>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-xs-12">
        {% if route.sent %}
        <p>No opinion yet</p>
        <a href="{{ url_for('opinions.add_opinion', climber_id=user_id, route_id=route.id) }}"
            class="btn btn-success">Add</a>
        {% else %}
        <p>You need to send the route to add an opinion</p>
        {% endif %}
    </div>
    {% endif %}
</div>

{% if route.opinions|rejectattr("climber_id", "equalto", user_id)|list|length > 0 %}
<div class="container px-0 px-lg-5">
    <h3 class="mx-3">Other opinions</h3>
    {% for opinion in route.opinions if opinion.climber_id != user_id %}
    <div class="card mb-3">
        <div class="card-header">
            <a href="{{ url_for('climbers.view_climber', climber_id=opinion.climber.id) }}">
                <h5 class="card-title">{{ opinion.climber.name }}</h5>
            </a>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/grade.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;">{{ opinion.grade.user_grade
                        }}</span>
                </div>
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/rating.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;"> {{ opinion.rating }}/5</span>
                </div>
                <div class="col">
                    <span style="vertical-align: middle; display: inline-block;">{% include 'icons/landing.html'
                        %}</span>
                    <span style="vertical-align: middle; display: inline-block;"> {{ route.landing }}/5</span>
                </div>
            </div>
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item"><b>Cruxes:</b> {{ opinion.cruxes|map(attribute="name")|join(", ") }}</li>
            <li class="list-group-item">{{ opinion.comment }}</li>
        </ul>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock content %}